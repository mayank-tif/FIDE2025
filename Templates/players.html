{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manage Players - FIDE World Cup 2025</title>
  <link rel="stylesheet" href="{% static 'assets/css/app.css' %}">
  <link rel="stylesheet" href="{% static 'assets/css/bootstrap.css' %}">
  <style>

        /* Responsive Players Table Styles */

/* Base table styles - Desktop view */
.table-responsive-wrapper {
    width: 100%;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}

#players-table {
    width: 100%;
    min-width: 100%;
}

/* Tablet view (768px - 1024px) */
@media screen and (max-width: 1024px) {
    #players-table {
        font-size: 14px;
    }
    
    #players-table th,
    #players-table td {
        padding: 8px 6px;
    }
    
    /* Make action buttons smaller */
    .btn-icon {
        font-size: 16px;
        padding: 4px;
    }
}

/* Mobile view - Card Layout (below 768px) */
@media screen and (max-width: 768px) {
    /* Hide table headers */
    #players-table thead {
        display: none;
    }
    
    /* Display table as block */
    #players-table,
    #players-table tbody,
    #players-table tr,
    #players-table td {
        display: block;
        width: 100%;
    }
    
    /* Style each row as a card */
    #players-table tr {
        margin-bottom: 20px;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        background: #fff;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    #players-table tr.odd {
        background: #fff;
    }
    
    #players-table tr.even {
        background: #fafafa;
    }
    
    /* Style table cells */
    #players-table td {
        border: none;
        padding: 8px 0;
        position: relative;
        padding-left: 50%;
        text-align: left;
    }
    
    /* Add labels before each cell */
    #players-table td:before {
        content: attr(data-label);
        position: absolute;
        left: 0;
        width: 45%;
        padding-right: 10px;
        font-weight: bold;
        text-align: left;
        color: #333;
    }
    
    /* Serial number styling */
    #players-table td.sorting_1:before {
        content: "S.No.";
    }
    
    /* Hide serial number or make it a badge */
    #players-table td.sorting_1 {
        position: absolute;
        top: 15px;
        right: 15px;
        padding: 0;
        background: #6c63ff;
        color: white;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 12px;
    }
    
    #players-table td.sorting_1:before {
        display: none;
    }
    
    /* Avatar styling */
    #players-table td.avatar {
        display: inline-table;
        justify-content: center;
        margin-bottom: 10px;
        height: 60px;
        width: 60px;
        margin-left: 0px;
        padding: 5px;
    }
    
    #players-table td.avatar:before {
        display: none;
    }
    
    .avatar-wrapper {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #e0e0e0;
        overflow: hidden;
    }
    
    .avatar-initials {
        font-size: 28px;
        font-weight: bold;
        color: #6c63ff;
    }
    
    .player-avatar {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    /* Player name - make it prominent */
    #players-table td:nth-child(3) {
        font-size: 18px;
        font-weight: bold;
        color: #333;
        padding-left: 0;
        text-align: center;
        margin-bottom: 15px;
        border-bottom: 1px solid #eee;
        padding-bottom: 15px;
    }
    
    #players-table td:nth-child(3):before {
        display: none;
    }
    
    /* Email styling */
    #players-table td:nth-child(4):before {
        content: "Email-";
        display: contents;

    }
    
    /* Tournament status styling */
    #players-table td.status:before {
        content: "Tournament Status";
    }
    
    #players-table td.status {
        padding-left: 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    #players-table td.status:before {
        position: static;
        width: auto;
    }
    
    /* Transportation status */
    #players-table td:nth-child(6):before {
        content: "Transportation";
    }
    
    #players-table td:nth-child(6) {
        padding-left: 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    #players-table td:nth-child(6):before {
        position: static;
        width: auto;
    }
    
    /* Actions styling */
    #players-table td:nth-child(7) {
        padding-left: 0;
        text-align: center;
        margin-top: 15px;
        border-top: 1px solid #eee;
        padding-top: 15px;
        display: flex;
        justify-content: center;
        gap: 15px;
    }
    
    #players-table td:nth-child(7):before {
        display: none;
    }
    
    .btn-icon {
        font-size: 24px;
        background: none;
        border: none;
        cursor: pointer;
        padding: 8px;
    }
    
    /* Badge styling */
    .badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
        white-space: nowrap;
    }
    
    .badge--active {
        background: #d4edda;
        color: #155724;
    }
    
    .badge--knocked {
        background: #f8d7da;
        color: #721c24;
    }
}

/* Extra small mobile (below 480px) */
@media screen and (max-width: 480px) {
    #players-table tr {
        padding: 12px;
        margin-bottom: 15px;
    }
    
    #players-table td {
        font-size: 14px;
        padding: 6px 0;
    }
    
    #players-table td:nth-child(3) {
        font-size: 16px;
        text-align: left;
    }
    
    .avatar-wrapper {
        width: 60px;
        height: 60px;
    }
    
    .avatar-initials {
        font-size: 22px;
    }
    
    .btn-icon {
        font-size: 20px;
        padding: 6px;
    }
}

/* Search bar responsive */
@media screen and (max-width: 768px) {
    .search-wrapper {
        margin-bottom: 20px;
    }
    
    input[type="search"] {
        width: 100%;
        padding: 10px;
        font-size: 16px;
    }
    
    /* Stack export and add player buttons */
    .button-group {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-bottom: 20px;
    }
    
    .button-group button {
        width: 100%;
    }
}

/* Horizontal scroll for very small screens as fallback */
@media screen and (max-width: 320px) {
    .table-responsive-wrapper {
        margin: 0 -15px;
        padding: 0 15px;
    }
}

        /* Additional page styles */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: #f5f5f5;
        }
        
    
        
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .page-header h1 {
            margin: 0;
            font-size: 28px;
            color: #333;
        }
        
        .search-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .search-input {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            min-width: 250px;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: #6c63ff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a52d5;
        }
        
        .btn-secondary {
            background: #343a40;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #23272b;
        }
        
        @media screen and (max-width: 768px) {
            .page-header h1 {
                font-size: 22px;
                width: 100%;
            }
            
            .search-section {
                flex-direction: column;
            }
            
            .search-input {
                width: 100%;
                min-width: auto;
            }
            
            .button-group {
                width: 100%;
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }
    
    .toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .toolbar-actions {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .header-actions {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-left: auto;
    }

    .btn--secondary {
        background: #271f64;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        font-size: 14px;
        transition: background-color 0.2s;
        white-space: nowrap;
    }

    .btn--secondary:hover {
        background: #545b62;
    }

    .btn--secondary:disabled {
        background: #a0a0a0;
        cursor: not-allowed;
    }

    .loader {
        display: inline-block;
        width: 12px;
        height: 12px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 5px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
    }
    .transport-modal .modal-content {
    max-width: 600px;
}

.form-row {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #495057;
}

.form-group select {
    width: 100%;
    padding: 10px 12px;
    border: 2px solid #e9ecef;
    border-radius: 6px;
    font-size: 14px;
    background: white;
    cursor: pointer;
}

.form-group select:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
}

.selected-info {
    margin: 20px 0;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    border-left: 4px solid #17a2b8;
}

.info-card h4 {
    margin: 0 0 10px 0;
    color: #495057;
}

.detail-item {
    margin: 8px 0;
    padding: 8px 12px;
    background: white;
    border-radius: 4px;
    border: 1px solid #e9ecef;
}

.detail-item strong {
    color: #495057;
}

.no-data-available {
    text-align: center;
    padding: 20px;
    color: #6c757d;
}

.no-data-available ul {
    text-align: left;
    margin: 10px 0;
    padding-left: 20px;
}

.no-data-available li {
    margin: 5px 0;
    font-size: 13px;
}

.info-text {
    color: #6c757d;
    font-size: 14px;
    margin: 5px 0 0 0;
}

.loader {
    display: inline-block;
    width: 12px;
    height: 12px;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-right: 5px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
  </style>
</head>
<body>
  <div class="app-shell">
    {% include 'sidebar.html' %}
    <main class="main-content">
      <div class="page-header">
        <h1>Manage Players</h1>
        <div class="header-actions">
        </div>
      </div>
      <div class="toolbar">
        <div class="search-box" id="tableSearchContainer"></div>
        <div class="toolbar-actions">
          <button class="btn btn--secondary" id="export-btn">
            üìä Export to Excel
          </button>
          <button class="btn btn--primary" data-modal-open="add-player-modal">
            + Add Player
          </button>
        </div>
      </div>

      <div class="table-container">
        {% csrf_token %}
        <table id="players-table" data-page-size="10" class="table table-bordered table-striped">
          <thead>
            <tr>
              <th>S.No.</th>
              <th>Photo</th>
              <th>Player Name</th>
              <th>Email</th>
              <th>Tournament Status</th>
              <th>Transport Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
        <nav id="paginationControls" class="pagination-container">
            <ul class="pagination"></ul>
        </nav>
      </div>
      
    </main>
  </div>

  <!-- Transport Status Modal -->
<div id="transport-status-modal" class="modal transport-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Update Transport Status</h3>
            <button class="modal-close" data-modal-close>&times;</button>
        </div>
        <div class="modal-body">
            <form id="transport-status-form">
                <div id="transport-status-content">
                    <p>Loading transport options...</p>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="roaster-select">Select Roaster:</label>
                        <select id="roaster-select" name="roaster_id" required>
                            <option value="">Select a roaster</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="status-select">Select Status:</label>
                        <select id="status-select" name="status_type" required>
                            <option value="">Select a status</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn--secondary" data-modal-close>Cancel</button>
                    <button type="submit" class="btn btn--primary" id="update-status-btn">Update Status</button>
                </div>
            </form>
        </div>
    </div>
</div>

  <!-- Add Player Modal -->
  <div id="add-player-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Add New Player</h2>
        <button class="modal-close" data-modal-close>&times;</button>
      </div>
      <form id="add-player-form" class="modal-body">
        <div class="form-group">
          <label for="player-name">Player Name</label>
          <input type="text" id="player-name" name="name" placeholder="e.g., Magnus Carlsen" required>
        </div>
        <div class="form-group">
          <label for="player-fide-id">Player FIDE ID</label>
          <input type="text" id="player-fide-id" name="fideId" placeholder="e.g., #1234" required>
        </div>
        <div class="form-group">
          <label for="player-age">Age</label>
          <input type="number" id="player-age" name="age" placeholder="e.g., 28">
        </div>
        <div class="form-group">
          <label for="player-gender">Gender</label>
          <select id="player-gender" name="gender">
            <option value="">Select</option>
            <option value="Male">Male</option>
            <option value="Female">Female</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div class="form-group">
          <label for="player-country">Country</label>
          <select id="player-country" name="country">
            <option value="">Select</option>
            {% for country in countries %}
               <option value="{{ country.country_id }}">{{ country.country_name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="form-group">
          <label for="player-email">Email</label>
          <input type="email" id="player-email" name="email" placeholder="e.g., magnus@example.com" required>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn--secondary" data-modal-close>Cancel</button>
          <button type="submit" class="btn btn--primary">Add Player</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Player Modal -->
  <div id="edit-player-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Edit Player</h2>
        <button class="modal-close" data-modal-close>&times;</button>
      </div>
      <form id="edit-player-form" class="modal-body">
        <input type="hidden" id="edit-player-id" name="id">
        <div class="form-group">
          <label for="edit-player-name">Player Name</label>
          <input type="text" id="edit-player-name" name="name" required>
        </div>
        <div class="form-group">
          <label for="edit-player-fide-id">Player FIDE ID</label>
          <input type="text" id="edit-player-fide-id" name="fideId" placeholder="e.g., #1234" required>
        </div>
        <div class="form-group">
          <label for="edit-player-age">Age</label>
          <input type="number" id="edit-player-age" name="age">
        </div>
        <div class="form-group">
          <label for="edit-player-gender">Gender</label>
          <select id="edit-player-gender" name="gender">
            <option value="Male">Male</option>
            <option value="Female">Female</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div class="form-group">
          <label for="edit-player-country">Country</label>
          <select id="edit-player-country" name="country">
            <option value="">Select</option>
            {% for country in countries %}
               <option value="{{ country.country_id }}">{{ country.country_name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="form-group">
          <label for="edit-player-email">Email</label>
          <input type="email" id="edit-player-email" name="email" required>
        </div>
        <div class="form-group">
          <label for="edit-player-status">Status</label>
          <select id="edit-player-status" name="status" required>
            <option value="ACTIVE">Active</option>
            <option value="DEPARTED">Departed</option>
            <option value="KNOCKED_OUT">Knocked Out</option>
          </select>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn--secondary" data-modal-close>Cancel</button>
          <button type="submit" class="btn btn--primary editPlayerForm">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <template id="tpl-player-row">
    <tr data-id="" data-status="" data-email="" data-country="" data-name="" data-age="" data-gender="">
      <td class="avatar" data-initials=""></td>
      <td class="name"></td>
      <td class="age"></td>
      <td class="gender"></td>
      <td class="country"></td>
      <td class="email"></td>
      <td class="status"><span class="badge"></span></td>
      <td class="actions">
        <button class="btn-icon" data-action="view" title="View Profile">üëÅÔ∏è</button>
        <button class="btn-icon" data-action="edit" title="Edit">‚úèÔ∏è</button>
        <button class="btn-icon" data-action="delete" title="Delete">üóëÔ∏è</button>
      </td>
    </tr>
  </template>
  <!-- jQuery CDN -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="{% static 'assets/js/app.js' %}"></script>

  <!-- DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

  <script>
    function loadTransportStatusOptions(playerId, playerName) {
    $.ajax({
        url: `/players/${playerId}/transport-status/`,
        method: 'GET',
        success: function(data) {
            if (data.error) {
                $('#transport-status-content').html(`
                    <div class="error-message">
                        <p>Error loading transport status: ${data.error}</p>
                    </div>
                `);
                return;
            }

            let html = `
            `;

            $('#transport-status-content').html(html);

            // Populate roasters dropdown
            const roasterSelect = $('#roaster-select');
            roasterSelect.empty().append('<option value="">Select a roaster</option>');
            
            data.roasters.forEach(roaster => {
                roasterSelect.append(`
                    <option value="${roaster.id}" 
                            data-pickup="${roaster.pickup_location}"
                            data-drop="${roaster.drop_location}"
                            data-vehicle-no="${roaster.vehicle_no}"
                            data-vehicle-type="${roaster.vehicle_type}"
                            data-travel-date="${roaster.travel_date || 'No date'}">
                        ${roaster.display_text}
                    </option>
                `);
            });

            // Populate status dropdown
            const statusSelect = $('#status-select');
            statusSelect.empty().append('<option value="">Select a status</option>');
            
            data.status_options.forEach(status => {
                statusSelect.append(`
                    <option value="${status.status_type}" 
                            data-player-status="${status.player_status}"
                            data-display-text="${status.display_text}">
                        ${status.display_text}
                    </option>
                `);
            });

            // Show form if we have data
            if (data.roasters.length > 0 && data.status_options.length > 0) {
                $('.form-row').show();
                $('#update-status-btn').prop('disabled', false);
            } else {
                let errorHtml = `
                    <div class="no-data-available">
                        <p>No transport data available.</p>
                        <ul>
                            ${data.roasters.length === 0 ? '<li>No roasters available</li>' : ''}
                            ${data.status_options.length === 0 ? '<li>No status mappings available</li>' : ''}
                        </ul>
                    </div>
                `;
                $('#transport-status-content').append(errorHtml);
                $('.form-row').hide();
                $('#update-status-btn').prop('disabled', true);
            }
        },
        error: function(error) {
            $('#transport-status-content').html(`
                <div class="error-message">
                    <p>Error loading transport status: ${error.statusText}</p>
                </div>
            `);
        }
    });
}

// Handle dropdown changes to show selected information
$(document).on('change', '#roaster-select, #status-select', function() {
    const roasterSelect = $('#roaster-select');
    const statusSelect = $('#status-select');
    const selectedInfo = $('#selected-info');
    const roasterDetails = $('#roaster-details');
    const statusDetails = $('#status-details');
    
    const selectedRoaster = roasterSelect.find('option:selected');
    const selectedStatus = statusSelect.find('option:selected');
    
    if (selectedRoaster.val() && selectedStatus.val()) {
        // Show roaster details
        roasterDetails.html(`
            <div class="detail-item">
                <strong>Roaster:</strong> ${selectedRoaster.text()}
            </div>
        `);
        
        // Show status details
        statusDetails.html(`
            <div class="detail-item">
                <strong>Status:</strong> ${selectedStatus.data('display-text')}
            </div>
        `);
        
        selectedInfo.show();
    } else {
        selectedInfo.hide();
    }
});

// Close transport modal function
function closeTransportModal() {
    $('#transport-status-modal').removeClass('active');
    $('#transport-status-content').html('<p>Loading transport options...</p>');
    $('#transport-status-form')[0].reset();
    $('#selected-info').hide();
    $('#update-status-btn').prop('disabled', false).html('Update Status');
}

// Handle form submission
$(document).on('submit', '#transport-status-form', function(e) {
    e.preventDefault();
    
    const playerId = currentPlayerId;
    const roasterId = $('#roaster-select').val();
    const statusType = $('#status-select').val();
    
    if (!roasterId || !statusType) {
        showMessage('Please select both roaster and status', 'error');
        return;
    }
    
    const formData = new FormData();
    formData.append('roaster_id', roasterId);
    formData.append('status_type', statusType);
    formData.append('csrfmiddlewaretoken', $("input[name='csrfmiddlewaretoken']").val());

    // Show loading state
    $('#update-status-btn').prop('disabled', true).html('<span class="loader"></span> Updating...');

    $.ajax({
        url: `/players/${playerId}/transport-status/`,
        method: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(data) {
            if (data.success) {
                closeTransportModal();
                showMessage(data.message, 'success');
                
                // Reload the players table to show updated status
                fetchPlayers();
            } else {
                showMessage('Error: ' + data.error, 'error');
                $('#update-status-btn').prop('disabled', false).html('Update Status');
            }
        },
        error: function(error) {
            showMessage('Error updating status: ' + error.statusText, 'error');
            $('#update-status-btn').prop('disabled', false).html('Update Status');
        }
    });
});

// Modal open function
function openTransportStatusModal(playerId, playerName) {
    currentPlayerId = playerId;
    currentPlayerName = playerName;
    
    $('#transport-status-modal').addClass('active');
    
    // Reset form
    $('#transport-status-form')[0].reset();
    $('#selected-info').hide();
    $('#update-status-btn').prop('disabled', false).html('Update Status');
    
    loadTransportStatusOptions(playerId, playerName);
}
</script>

  <script>
      let currentPage = 1;

      function reinitializeDataTable(tableId) {
        let tableSelector = `#${tableId}`;

        // Check if the table exists
        if ($(tableSelector).length) {
            // If DataTable already exists, clear and redraw
            if ($.fn.DataTable.isDataTable(tableSelector)) {
                $(tableSelector).DataTable();
            } else {
                // Initialize DataTable only if it does not exist
                $(tableSelector).DataTable({
                    paging: false,
                    ordering: true,
                    info: false,
                    destroy: true,
                    dom: '<"top"f>rt<"bottom"lp><"clear">',
                    initComplete: function () {
                        // Move the search box to our toolbar container
                        $(`#${tableId}_filter`).appendTo("#tableSearchContainer");
                    }
                });
            }
        }
      }

      function getStatusBadge(status) {
          switch(status) {
              case "Active":
                  return '<span class="badge badge--active">Active</span>';
              case "Departed":
                  return '<span class="badge badge--departed">Departed</span>';
              case "Knocked Out":
                  return '<span class="badge badge--knocked">Knocked Out</span>';
              default:
                  return `<span class="badge">${status}</span>`;
          }
      }

      // Export functionality
      function exportPlayersToExcel() {
          const exportBtn = document.getElementById('export-btn');
          exportBtn.innerHTML = '‚è≥ Exporting...';
          exportBtn.disabled = true;

          // Call export endpoint
          window.location.href = "{% url 'export_players' %}";

          setTimeout(() => {
              exportBtn.innerHTML = 'üìä Export to Excel';
              exportBtn.disabled = false;
          }, 3000);
      }


      function fetchPlayers() {
          let csrfToken = $("input[name='csrfmiddlewaretoken']").val();      

          $.ajax({
              url: "{% url 'players' %}",
              data: { action: "fetch", page: currentPage },
              method: "POST",
              headers: {
                  "X-CSRFToken": csrfToken
              },
              success: function(response) {
                  $("#players-table tbody").empty();      

                  if (response.data.length > 0) {
                      response.data.forEach((player, index) => {
                          let serialNo = (currentPage - 1) * response.pagination.per_page + index + 1;
                          let imgHtml = player.image_url 
    ? `<div class="avatar-wrapper"><img src="${player.image_url}" alt="${player.name}" class="player-avatar"></div>`
    : `<div class="avatar-wrapper"><div class="avatar-initials">${player.name ? player.name.slice(0,2).toUpperCase() : "P"}</div></div>`;


                          let row = `
                              <tr data-id="${player.id}">
                                  <td>${serialNo}</td>
                                  <td class="avatar">${imgHtml}</td>
                                  <td>${player.name|| ''}</td>
                                  <td>${player.email|| ''}</td>
                                  <td class="status">${getStatusBadge(player.status)}</td>
                                  <td><i>${player.transportation_status || ''}</i></td>
                                  <td>
                                      <button class="profileView btn-icon" data-action="view" title="View Profile" data-id="${player.id}">üëÅÔ∏è</button>
                                      <button class="transport-status-btn btn-icon" data-action="transport-status" title="Transport Status" data-id="${player.id}" data-name="${player.name}">üöó</button>
                                      <button class="delete-btn btn-icon" data-action="delete" title="Delete" data-id="${player.id}">üóëÔ∏è</button>
                                  </td>
                              </tr>
                          `;
                          $("#players-table tbody").append(row);
                      });
                      reinitializeDataTable("players-table");
                  } else {
                      $("#players-table tbody").append('<tr><td colspan="10">No players found</td></tr>');
                  }      

                  // Update pagination controls
                  updatePagination(
                      response.pagination.current_page,
                      response.pagination.total_pages,
                      response.pagination.page_list,
                      response.pagination.has_prev,
                      response.pagination.has_next
                  );
                  currentPage = response.pagination.current_page;
              }
          });
      }

      function updatePagination(currentPage, totalPages, newPageList, hasPrevious, hasNext) {
        let paginationHtml = '<ul class="pagination">';
    
        // First & Previous buttons
        if (hasPrevious) {
            paginationHtml += `<li><a href="javascript:void(0);" class="page-btn" data-page="1" aria-label="First"><span aria-hidden="true">First</span></a></li>`;
            paginationHtml += `<li><a href="javascript:void(0);" class="page-btn" data-page="${currentPage - 1}" aria-label="Previous"><span aria-hidden="true">Previous</span></a></li>`;
        }
    
        // Page number links
        if (totalPages > 1) {
            newPageList.forEach(page => {
                let activeClass = currentPage === page ? "active" : "";
                paginationHtml += `<li class="${activeClass}"><a href="javascript:void(0);" class="page-btn" data-page="${page}">${page}</a></li>`;
            });
        }
    
        // Next & Last buttons
        if (hasNext) {
            paginationHtml += `<li><a href="javascript:void(0);" class="page-btn" data-page="${currentPage + 1}" aria-label="Next"><span aria-hidden="true">Next</span></a></li>`;
            paginationHtml += `<li><a href="javascript:void(0);" class="page-btn" data-page="${totalPages}" aria-label="Last"><span aria-hidden="true">Last</span></a></li>`;
        }
    
        paginationHtml += '</ul>';
        $("#paginationControls").html(paginationHtml);
      }
    
      // Handle click event for pagination buttons
      $(document).on("click", ".page-btn", function () {
        let newPage = $(this).data("page");
        currentPage = newPage;
        fetchPlayers();
      });

      $(document).ready(function() {
          fetchPlayers();
          $(document).on("click", ".transport-status-btn", function() {
        const playerId = $(this).data("id");
        const playerName = $(this).data("name");
        openTransportStatusModal(playerId, playerName);
    });

          // Add export button event listener
          document.getElementById('export-btn').addEventListener('click', exportPlayersToExcel);

          $(document).on("click", ".profileView", function() {
              const playerId = $(this).data("id"); 
              const url = `/player/${playerId}/`;
              window.location.href = url;
          });

          $(document).on("click", "[data-modal-open]", function() {
              const modalId = $(this).data("modal-open");
              $("#" + modalId).addClass("active");
          });

          $(document).on("click", "[data-modal-close], .modal", function(e) {
              if ($(e.target).is(".modal") || $(e.target).is("[data-modal-close]")) {
                  $(this).closest(".modal").removeClass("active");
              }
          });

          $("#add-player-form").on("submit", function (e) {
              e.preventDefault();
              csrfmiddlewaretoken = $("input[name='csrfmiddlewaretoken']").val()
              data = {
                action: "add",
                name: $("#player-name").val(),
                email: $("#player-email").val(),
                gender: $("#player-gender").val(),
                age: $("#player-age").val(),
                country: $("#player-country").val(),
                fideId: $("#player-fide-id").val(),
                csrfmiddlewaretoken: csrfmiddlewaretoken

              }

              $.ajax({
                  url: "{% url 'players' %}",
                  type: "POST",
                  data: data,
                  headers: {
                      "X-CSRFToken": csrfmiddlewaretoken
                  },
                  success: function (response) {
                      if (response.success) {
                          $("#add-player-form")[0].reset();
                          $("#add-player-modal").removeClass("active");
                          fetchPlayers();
                      } else {
                          showMessage(response.error || "Failed to add player");
                      }
                  },
                  error: function (xhr) {
                      console.error("Error adding player:", xhr.responseText);
                  }
              });
           });

          
          // EDIT PLAYER (get details)
        
           $(document).on("click", ".edit-btn", function () {
             const playerId = $(this).data("id");
             $.ajax({
                 url: "{% url 'players' %}",
                 type: "POST",
                 data: {
                     action: "get-player-details",
                     playerId: playerId,
                     page: 1,
                     csrfmiddlewaretoken: $("input[name='csrfmiddlewaretoken']").val()
                 },
                 success: function (response) {
                     const player = response.data;
                     if (!player) return showMessage("Player not found");
                     $("#edit-player-id").val(player.id);
                     $("#edit-player-name").val(player.name);
                     $("#edit-player-email").val(player.email);
                     $("#edit-player-gender").val(player.gender);
                     $("#edit-player-country").val(player.country);
                     $("#edit-player-age").val(player.age);
                     $("#edit-player-status").val(player.status);
                     $("#edit-player-fide-id").val(player.fideId);
                     // Open the modal (custom modal)
                     $("#edit-player-modal").addClass("active");
                 }
             });
           });
        
           // SAVE EDITED PLAYER
           $("#edit-player-form").on("submit", function (e) {
             e.preventDefault();
             $.ajax({
                 url: "{% url 'players' %}",
                 type: "POST",
                 data: {
                     action: "edit",
                     id: $("#edit-player-id").val(),
                     name: $("#edit-player-name").val(),
                     email: $("#edit-player-email").val(),
                     gender: $("#edit-player-gender").val(),
                     country: $("#edit-player-country").val(),
                     age: $("#edit-player-age").val(),
                     status: $("#edit-player-status").val(),
                     fideId : $("#edit-player-fide-id").val(),
                     csrfmiddlewaretoken: $("input[name='csrfmiddlewaretoken']").val()
                 },
                 success: function (response) {
                     if (response.success) {
                         $("#edit-player-modal").removeClass("active");
                         fetchPlayers();
                     } else {
                         showMessage(response.error || "Failed to update player");
                     }
                 },
                 error: function (xhr) {
                     console.error("Error updating player:", xhr.responseText);
                 }
             });
           });
        
           // DELETE PLAYER (confirmation modal)
           $(document).on("click", ".delete-btn", function () {
            const playerId = $(this).data("id");
            if (!confirm("Are you sure you want to delete this player?")) return;

            $.ajax({
                url: "{% url 'players' %}",
                type: "POST",
                data: {
                    action: "delete",
                    id: playerId,
                    csrfmiddlewaretoken: $("input[name='csrfmiddlewaretoken']").val()
                },
                success: function (response) {
                    if (response.success) {
                        fetchPlayers();
                    } else {
                        showMessage(response.error || "Failed to delete player");
                    }
                },
                error: function (xhr) {
                    console.error("Error deleting player:", xhr.responseText);
                }
            });
           });
      });
    </script>
</body>
</html>