{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manage Players - FIDE World Cup 2025</title>
  <link rel="stylesheet" href="{% static 'assets/css/app.css' %}">
  <link rel="stylesheet" href="{% static 'assets/css/bootstrap.css' %}">
</head>
<body>
  <div class="app-shell">
    {% include 'sidebar.html' %}
    <main class="main-content">
      <div class="page-header">
        <h1>Manage Players</h1>
      </div>
      <div class="toolbar">
        <div class="search-box" id="tableSearchContainer">
          {% comment %} <input type="text" id="player-search" placeholder="Search Players"> {% endcomment %}
        </div>
        <button class="btn btn--primary" data-modal-open="add-player-modal">
          + Add Player
        </button>
      </div>
      <div class="table-container">
        {% csrf_token %}
        <table id="players-table" data-page-size="10" class="table table-bordered table-striped">
          <thead>
            <tr>
              <th>S.No.</th>
              <th>Photo</th>
              <th>Player Name</th>
              <th>Age</th>
              <th>Gender</th>
              <th>Country</th>
              <th>Email</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
        <nav id="paginationControls" class="pagination-container">
            <ul class="pagination"></ul>
        </nav>
      </div>
      
    </main>
  </div>

  <!-- Add Player Modal -->
  <div id="add-player-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Add New Player</h2>
        <button class="modal-close" data-modal-close>&times;</button>
      </div>
      <form id="add-player-form" class="modal-body">
        <div class="form-group">
          <label for="player-name">Player Name</label>
          <input type="text" id="player-name" name="name" placeholder="e.g., Magnus Carlsen" required>
        </div>
        <div class="form-group">
          <label for="player-fide-id">Player FIDE ID</label>
          <input type="text" id="player-fide-id" name="fideId" placeholder="e.g., #1234" required>
        </div>
        <div class="form-group">
          <label for="player-age">Age</label>
          <input type="number" id="player-age" name="age" placeholder="e.g., 28" required>
        </div>
        <div class="form-group">
          <label for="player-gender">Gender</label>
          <select id="player-gender" name="gender" required>
            <option value="">Select</option>
            <option value="Male">Male</option>
            <option value="Female">Female</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div class="form-group">
          <label for="player-country">Country</label>
          <select id="player-country" name="country" required>
            <option value="">Select</option>
            {% for country in countries %}
               <option value="{{ country.country_id }}">{{ country.country_name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="form-group">
          <label for="player-email">Email</label>
          <input type="email" id="player-email" name="email" placeholder="e.g., magnus@example.com" required>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn--secondary" data-modal-close>Cancel</button>
          <button type="submit" class="btn btn--primary">Add Player</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Player Modal -->
  <div id="edit-player-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Edit Player</h2>
        <button class="modal-close" data-modal-close>&times;</button>
      </div>
      <form id="edit-player-form" class="modal-body">
        <input type="hidden" id="edit-player-id" name="id">
        <div class="form-group">
          <label for="edit-player-name">Player Name</label>
          <input type="text" id="edit-player-name" name="name" required>
        </div>
        <div class="form-group">
          <label for="edit-player-fide-id">Player FIDE ID</label>
          <input type="text" id="edit-player-fide-id" name="fideId" placeholder="e.g., #1234" required>
        </div>
        <div class="form-group">
          <label for="edit-player-age">Age</label>
          <input type="number" id="edit-player-age" name="age" required>
        </div>
        <div class="form-group">
          <label for="edit-player-gender">Gender</label>
          <select id="edit-player-gender" name="gender" required>
            <option value="Male">Male</option>
            <option value="Female">Female</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div class="form-group">
          <label for="edit-player-country">Country</label>
          <select id="edit-player-country" name="country" required>
            <option value="">Select</option>
            {% for country in countries %}
               <option value="{{ country.country_id }}">{{ country.country_name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="form-group">
          <label for="edit-player-email">Email</label>
          <input type="email" id="edit-player-email" name="email" required>
        </div>
        <div class="form-group">
          <label for="edit-player-status">Status</label>
          <select id="edit-player-status" name="status" required>
            <option value="ACTIVE">Active</option>
            <option value="DEPARTED">Departed</option>
            <option value="KNOCKED_OUT">Knocked Out</option>
          </select>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn--secondary" data-modal-close>Cancel</button>
          <button type="submit" class="btn btn--primary editPlayerForm">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <template id="tpl-player-row">
    <tr data-id="" data-status="" data-email="" data-country="" data-name="" data-age="" data-gender="">
      <td class="avatar" data-initials=""></td>
      <td class="name"></td>
      <td class="age"></td>
      <td class="gender"></td>
      <td class="country"></td>
      <td class="email"></td>
      <td class="status"><span class="badge"></span></td>
      <td class="actions">
        <button class="btn-icon" data-action="view" title="View Profile">üëÅÔ∏è</button>
        <button class="btn-icon" data-action="edit" title="Edit">‚úèÔ∏è</button>
        <button class="btn-icon" data-action="delete" title="Delete">üóëÔ∏è</button>
      </td>
    </tr>
  </template>
  <!-- jQuery CDN -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>


  {% comment %} <script type="module" src="{% static 'assets/js/app.js' %}"></script> {% endcomment %}

  <script>

      let currentPage = 1;

      function reinitializeDataTable(tableId) {
        let tableSelector = `#${tableId}`;

        // Check if the table exists
        if ($(tableSelector).length) {
            // If DataTable already exists, clear and redraw
            if ($.fn.DataTable.isDataTable(tableSelector)) {
                $(tableSelector).DataTable();
            } else {
                // Initialize DataTable only if it does not exist
                $(tableSelector).DataTable({
                    paging: false,
                    ordering: true,
                    info: false,
                    destroy: true,
                    dom: '<"top"f>rt<"bottom"lp><"clear">',
                    initComplete: function () {
                        // Move the search box to our toolbar container
                        $(`#${tableId}_filter`).appendTo("#tableSearchContainer");
                    }
                });
            }
        }
      }

      function getStatusBadge(status) {
          switch(status) {
              case "Active":
                  return '<span class="badge badge--active">Active</span>';
              case "Departed":
                  return '<span class="badge badge--departed">Departed</span>';
              case "Knocked Out":
                  return '<span class="badge badge--knocked">Knocked Out</span>';
              default:
                  return `<span class="badge">${status}</span>`;
          }
      }


      function fetchPlayers() {
          let csrfToken = $("input[name='csrfmiddlewaretoken']").val();      

          $.ajax({
              url: "{% url 'players' %}",
              data: { action: "fetch", page: currentPage },
              method: "POST",
              headers: {
                  "X-CSRFToken": csrfToken
              },
              success: function(response) {
                  $("#players-table tbody").empty();      

                  if (response.data.length > 0) {
                      response.data.forEach((player, index) => {
                          let serialNo = (currentPage - 1) * response.pagination.per_page + index + 1;
                          let imgHtml = player.image_url 
    ? `<div class="avatar-wrapper"><img src="${player.image_url}" alt="${player.name}" class="player-avatar"></div>`
    : `<div class="avatar-wrapper"><div class="avatar-initials">${player.name ? player.name.slice(0,2).toUpperCase() : "P"}</div></div>`;


                          let row = `
                              <tr data-id="${player.id}">
                                  <td>${serialNo}</td>
                                  <td class="avatar">${imgHtml}</td>
                                  <td>${player.name|| ''}</td>
                                  <td>${player.age|| ''}</td>
                                  <td>${player.gender|| ''}</td>
                                  <td>${player.country|| ''}</td>
                                  <td>${player.email|| ''}</td>
                                  <td class="status">${getStatusBadge(player.status)}</td>
                                  <td>
                                      <button class="profileView btn-icon" data-action="view" title="View Profile" data-id="${player.id}">üëÅÔ∏è</button>
                                      
                                      <button class="delete-btn btn-icon" data-action="delete" title="Delete" data-id="${player.id}">üóëÔ∏è</button>
                                  </td>
                              </tr>
                          `;
                          $("#players-table tbody").append(row);
                      });
                      reinitializeDataTable("players-table");
                  } else {
                      $("#players-table tbody").append('<tr><td colspan="6">No players found</td></tr>');
                  }      

                  // Update pagination controls
                  updatePagination(
                      response.pagination.current_page,
                      response.pagination.total_pages,
                      response.pagination.page_list,
                      response.pagination.has_prev,
                      response.pagination.has_next
                  );
                  currentPage = response.pagination.current_page;
              }
          });
      }

      function updatePagination(currentPage, totalPages, newPageList, hasPrevious, hasNext) {
        let paginationHtml = '<ul class="pagination">';
    
        // First & Previous buttons
        if (hasPrevious) {
            paginationHtml += `<li><a href="javascript:void(0);" class="page-btn" data-page="1" aria-label="First"><span aria-hidden="true">First</span></a></li>`;
            paginationHtml += `<li><a href="javascript:void(0);" class="page-btn" data-page="${currentPage - 1}" aria-label="Previous"><span aria-hidden="true">Previous</span></a></li>`;
        }
    
        // Page number links
        if (totalPages > 1) {
            newPageList.forEach(page => {
                let activeClass = currentPage === page ? "active" : "";
                paginationHtml += `<li class="${activeClass}"><a href="javascript:void(0);" class="page-btn" data-page="${page}">${page}</a></li>`;
            });
        }
    
        // Next & Last buttons
        if (hasNext) {
            paginationHtml += `<li><a href="javascript:void(0);" class="page-btn" data-page="${currentPage + 1}" aria-label="Next"><span aria-hidden="true">Next</span></a></li>`;
            paginationHtml += `<li><a href="javascript:void(0);" class="page-btn" data-page="${totalPages}" aria-label="Last"><span aria-hidden="true">Last</span></a></li>`;
        }
    
        paginationHtml += '</ul>';
        $("#paginationControls").html(paginationHtml);
      }
    
      // Handle click event for pagination buttons
      $(document).on("click", ".page-btn", function () {
        let newPage = $(this).data("page");
        currentPage = newPage;
        fetchPlayers();
      });

      $(document).ready(function() {
          fetchPlayers();

          $(document).on("click", ".profileView", function() {
              const playerId = $(this).data("id"); 
              const url = `/player/${playerId}/`;  // matches your urls.py pattern
              window.open(url, "_blank"); // open in new tab
          });



          $(document).on("click", "[data-modal-open]", function() {
              const modalId = $(this).data("modal-open");
              $("#" + modalId).addClass("active");
          });

          $(document).on("click", "[data-modal-close], .modal", function(e) {
              if ($(e.target).is(".modal") || $(e.target).is("[data-modal-close]")) {
                  $(this).closest(".modal").removeClass("active");
              }
          });

          $("#add-player-form").on("submit", function (e) {
              e.preventDefault();
              csrfmiddlewaretoken = $("input[name='csrfmiddlewaretoken']").val()
              data = {
                action: "add",
                name: $("#player-name").val(),
                email: $("#player-email").val(),
                gender: $("#player-gender").val(),
                age: $("#player-age").val(),
                country: $("#player-country").val(),
                fideId: $("#player-fide-id").val(),
                csrfmiddlewaretoken: csrfmiddlewaretoken

              }

              $.ajax({
                  url: "{% url 'players' %}",
                  type: "POST",
                  data: data,
                  headers: {
                      "X-CSRFToken": csrfmiddlewaretoken
                  },
                  success: function (response) {
                      if (response.success) {
                          $("#add-player-form")[0].reset();
                          $("#add-player-modal").removeClass("active");
                          fetchPlayers();
                      } else {
                          alert(response.error || "Failed to add player");
                      }
                  },
                  error: function (xhr) {
                      console.error("Error adding player:", xhr.responseText);
                  }
              });
           });

          
          // EDIT PLAYER (get details)
        
           $(document).on("click", ".edit-btn", function () {
             const playerId = $(this).data("id");
             $.ajax({
                 url: "{% url 'players' %}",
                 type: "POST",
                 data: {
                     action: "get-player-details",
                     playerId: playerId,
                     page: 1,
                     csrfmiddlewaretoken: $("input[name='csrfmiddlewaretoken']").val()
                 },
                 success: function (response) {
                     const player = response.data;
                     if (!player) return alert("Player not found");
                     $("#edit-player-id").val(player.id);
                     $("#edit-player-name").val(player.name);
                     $("#edit-player-email").val(player.email);
                     $("#edit-player-gender").val(player.gender);
                     $("#edit-player-country").val(player.country);
                     $("#edit-player-age").val(player.age);
                     $("#edit-player-status").val(player.status);
                     $("#edit-player-fide-id").val(player.fideId);
                     // Open the modal (custom modal)
                     $("#edit-player-modal").addClass("active");
                 }
             });
           });
        
           // SAVE EDITED PLAYER
           $("#edit-player-form").on("submit", function (e) {
             e.preventDefault();
             $.ajax({
                 url: "{% url 'players' %}",
                 type: "POST",
                 data: {
                     action: "edit",
                     id: $("#edit-player-id").val(),
                     name: $("#edit-player-name").val(),
                     email: $("#edit-player-email").val(),
                     gender: $("#edit-player-gender").val(),
                     country: $("#edit-player-country").val(),
                     age: $("#edit-player-age").val(),
                     status: $("#edit-player-status").val(),
                     fideId : $("#edit-player-fide-id").val(),
                     csrfmiddlewaretoken: $("input[name='csrfmiddlewaretoken']").val()
                 },
                 success: function (response) {
                     if (response.success) {
                         $("#edit-player-modal").removeClass("active");
                         fetchPlayers();
                     } else {
                         alert(response.error || "Failed to update player");
                     }
                 },
                 error: function (xhr) {
                     console.error("Error updating player:", xhr.responseText);
                 }
             });
           });
        
           // DELETE PLAYER (confirmation modal)
           $(document).on("click", ".delete-btn", function () {
            const playerId = $(this).data("id");
            if (!confirm("Are you sure you want to delete this player?")) return;

            $.ajax({
                url: "{% url 'players' %}",
                type: "POST",
                data: {
                    action: "delete",
                    id: playerId,
                    csrfmiddlewaretoken: $("input[name='csrfmiddlewaretoken']").val()
                },
                success: function (response) {
                    if (response.success) {
                        fetchPlayers();
                    } else {
                        alert(response.error || "Failed to delete player");
                    }
                },
                error: function (xhr) {
                    console.error("Error deleting player:", xhr.responseText);
                }
            });
           });
      });
    </script>
</body>
</html>