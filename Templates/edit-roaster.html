{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit Roaster - FIDE World Cup 2025</title>
  <link rel="stylesheet" href="{% static 'assets/css/app.css' %}">
  <style>
    #playersDropdownWrapper {
      position: relative;
    }
    #playersDropdownMenu {
      display: none;
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 5px;
      background: #fff;
      position: absolute;
      width: 100%;
      z-index: 10;
    }
    #playersDropdownWrapper.show #playersDropdownMenu {
      display: block;
    }
  </style>
</head>
<body>
  <div class="form-page">
    <div class="form-header">
      <button class="btn-back-arrow" onclick="goBack()">←</button>
      <h1>Edit Roaster</h1>
    </div>

    <div class="roaster-form-container">
      <form method="post" action="{% url 'edit_roaster' roaster.id %}">
        {% csrf_token %}
        <input type="hidden" name="current_page" value="{{ current_page }}">
        <div class="form-grid">
          <div class="form-group">
            <label for="vehicleType">Vehicle Type</label>
            <select id="vehicleType" name="vehicleType" required>
              <option value="">Select</option>
              <option value="Bus" {% if roaster.vechicle_type == "Bus" %}selected{% endif %}>Bus</option>
              <option value="Car" {% if roaster.vechicle_type == "Car" %}selected{% endif %}>Car</option>
            </select>
          </div>

          <div class="form-group">
            <label for="vehicleNumber">Vehicle Number</label>
            <input type="text" id="vehicleNumber" name="vehicleNumber" value="{{ roaster.vechicle_no }}" placeholder="e.g., DL-12-AB-3456" required>
          </div>

          <div class="form-group">
            <label for="numberOfSeats">Number of Player Seats</label>
            <input type="number" id="numberOfSeats" name="number_of_seats" min="1" value="{{ roaster.number_of_seats }}" required>
          </div>

          <div class="form-group">
            <label for="driverName">Driver Name</label>
            <input type="text" id="driverName" name="driverName" value="{{ roaster.driver_name }}" placeholder="e.g., Rajesh Kumar" required>
          </div>

          <div class="form-group">
            <label for="transport-type">Transportation Type</label>
            <select id="transport-type" name="transportationTypeId" required>
              <option value="">Select</option>
              {% for type in transportation_types %}
                  <option value="{{ type.id }}" {% if roaster.transportationTypeId_id == type.id %}selected{% endif %}>{{ type.Name }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="form-group">
            <label for="status-type">Status</label>
            <select id="status-type" name="status" required>
              <option value="">Select Status</option>
              {% for key, value in roaster_status_choices %}
                  <option value="{{ key }}" {% if roaster.status == key %}selected{% endif %}>{{ value }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="form-group">
            <label>Assigned Players</label>
            <div class="players-dropdown" id="playersDropdownWrapper">
              <button type="button" class="players-select-button" id="playersSelectButton">
                <span id="selectedPlayersText">Select</span> ▼
              </button>
              <div class="players-dropdown-menu" id="playersDropdownMenu">
                <input type="text" id="playerSearch" placeholder="Search players..." style="width: 100%; margin-bottom: 5px; padding: 5px;">
                {% for player in players %}
                <div class="player-option" data-name="{{ player.name|lower }}">
                  <input type="checkbox" id="player-{{ player.id }}" name="players" value="{{ player.id }}" {% if player.id in assigned_player_ids %}checked{% endif %}>
                  <label for="player-{{ player.id }}">{{ player.name }}</label>
                </div>
                {% endfor %}
              </div>
            </div>
            <div class="player-counter" id="playerCounter">0/0 players assigned</div>
          </div>

          <div class="form-group">
            <label for="date">Date & Time</label>
            <input type="datetime-local" id="date" name="travel_date" value="{{ roaster.travel_date|date:'Y-m-d\TH:i' }}" required>
          </div>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn--submit">Save Roaster</button>
          <button type="button" class="btn--cancel" onclick="goBack()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const currentPage = "{{ current_page }}";
    function goBack() {
      const url = new URL("{% url 'roaster_list' %}", window.location.origin);
      url.searchParams.set('page', currentPage);
      window.location.href = url.toString();
    }

    const numberOfSeatsInput = document.getElementById('numberOfSeats');
    const playerCounter = document.getElementById('playerCounter');
    const playerSearch = document.getElementById('playerSearch');
    const playersDropdownMenu = document.getElementById('playersDropdownMenu');
    const playersSelectButton = document.getElementById('playersSelectButton');
    const playerOptions = Array.from(playersDropdownMenu.querySelectorAll('.player-option'));
    const playersDropdownWrapper = document.getElementById('playersDropdownWrapper');

    playersSelectButton.addEventListener('click', () => {
      playersDropdownWrapper.classList.toggle('show');
    });

    document.addEventListener('click', function(e) {
      if (!playersDropdownWrapper.contains(e.target)) {
        playersDropdownWrapper.classList.remove('show');
      }
    });

    function updatePlayerCounter() {
      const checkboxes = playersDropdownMenu.querySelectorAll('input[type="checkbox"]:checked');
      const totalSeats = parseInt(numberOfSeatsInput.value || 0);
      playerCounter.textContent = `${checkboxes.length} players assigned`;
    }

    playersDropdownMenu.addEventListener('change', updatePlayerCounter);
    numberOfSeatsInput.addEventListener('input', updatePlayerCounter);

    playerSearch.addEventListener('input', function() {
      const query = this.value.toLowerCase();
      playerOptions.forEach(option => {
        option.style.display = option.dataset.name.includes(query) ? 'block' : 'none';
      });
    });

    // Initialize counter on page load
    document.addEventListener('DOMContentLoaded', updatePlayerCounter);
  </script>
</body>
</html>
