{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit Roaster - FIDE World Cup 2025</title>
  <link rel="stylesheet" href="{% static 'assets/css/app.css' %}">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <style>
    #playersDropdownWrapper {
      position: relative;
    }

    #playersDropdownMenu {
      display: none;
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 5px;
      background: #fff;
      position: absolute;
      width: 100%;
      z-index: 10;
    }

    #playersDropdownWrapper.show #playersDropdownMenu {
      display: block;
    }

    .player-counter {
      margin-top: 5px;
      font-size: 14px;
      color: #555;
    }

    /* Improved Custom Location Styles */
    .custom-location-group {
      margin-top: 8px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #e9ecef;
      border-left: 4px solid #007bff;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .custom-location-group:hover {
      background: #f1f3f4;
      border-color: #0056b3;
    }

    .custom-location-group label {
      font-weight: 600;
      color: #495057;
      margin-bottom: 8px;
      display: block;
      font-size: 14px;
    }

    .custom-location-group input {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid #e9ecef;
      border-radius: 6px;
      font-size: 14px;
      transition: all 0.3s ease;
      background: white;
      box-sizing: border-box;
    }

    .custom-location-group input:focus {
      outline: none;
      border-color: #007bff;
      box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
      background: #fff;
    }

    .custom-location-group input::placeholder {
      color: #6c757d;
      opacity: 0.7;
    }

    .custom-location-group input:valid {
      border-color: #28a745;
    }

    .custom-location-group input:invalid:not(:placeholder-shown) {
      border-color: #dc3545;
    }

    /* Error Message Styles */
    .error-message {
      color: #dc3545;
      font-size: 12px;
      margin-top: 6px;
      display: none;
      padding: 4px 8px;
      background: #f8d7da;
      border-radius: 4px;
      border-left: 3px solid #dc3545;
    }

    .location-error {
      border-color: #dc3545 !important;
      box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1) !important;
    }

    /* Form Group Enhancements */
    .form-group {
      position: relative;
    }

    .form-group label {
      font-weight: 600;
      color: #495057;
      margin-bottom: 8px;
      display: block;
    }

    /* Smooth transitions for all inputs */
    input, select {
      transition: all 0.3s ease;
    }

    input:focus, select:focus {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    /* Animation for custom location appearance */
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .custom-location-group[style*="display: block"] {
      animation: slideDown 0.3s ease-out;
    }

    /* Success state for valid custom inputs */
    .custom-location-group.valid {
      border-left-color: #28a745;
      background: #f8fff9;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .custom-location-group {
        padding: 12px;
        margin-top: 6px;
      }
      
      .custom-location-group input {
        padding: 8px 10px;
        font-size: 16px;
      }
    }

    /* Custom select styles to match */
    select {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid #e9ecef;
      border-radius: 6px;
      font-size: 14px;
      background: white;
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml;charset=US-ASCII,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 4 5'><path fill='%23333' d='M2 0L0 2h4zm0 5L0 3h4z'/></svg>");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 12px;
    }

    select:focus {
      outline: none;
      border-color: #007bff;
      box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
    }

    /* Make the form grid look more organized */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      align-items: start;
    }

    /* Ensure custom location groups span full width */
    .custom-location-group {
      grid-column: 1 / -1;
    }

    /* Disabled option styles */
    .disabled-option {
      color: #ccc;
      background-color: #f8f9fa;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    {% include 'sidebar.html' %}
    <main class="main-content">
      <div class="form-page">
        <div class="form-header">
          <button class="btn-back-arrow" onclick="goBack()">←</button>
          <h1>Edit Roaster</h1>
        </div>

        <div class="roaster-form-container">
          <form method="post" action="{% url 'edit_roaster' roaster.id %}" id="roasterForm">
            {% csrf_token %}
            <input type="hidden" name="current_page" value="{{ current_page }}">
            
            <div class="form-grid">
              <!-- Vehicle Information -->
              <div class="form-group">
                <label for="vehicleType">Vehicle Type</label>
                <select id="vehicleType" name="vehicleType" required>
                  <option value="">Select</option>
                  <option value="Bus" {% if roaster.vechicle_type == "Bus" %}selected{% endif %}>Bus</option>
                  <option value="Car" {% if roaster.vechicle_type == "Car" %}selected{% endif %}>Car</option>
                </select>
                <div class="error-message" id="vehicleTypeError">Please select a vehicle type</div>
              </div>

              <div class="form-group">
                <label for="vehicleNumber">Vehicle Number</label>
                <input type="text" id="vehicleNumber" name="vehicleNumber" value="{{ roaster.vechicle_no }}" placeholder="e.g., DL-12-AB-3456" required>
                <div class="error-message" id="vehicleNumberError">Please enter vehicle number</div>
              </div>

              <div class="form-group">
                <label for="numberOfSeats">Number of Player Seats</label>
                <input type="number" id="numberOfSeats" name="number_of_seats" min="1" value="{{ roaster.number_of_seats }}" required>
                <div class="error-message" id="seatsError">Please enter valid number of seats (minimum 1)</div>
              </div>

              <div class="form-group">
                <label for="driverName">Driver Name</label>
                <input type="text" id="driverName" name="driverName" value="{{ roaster.driver_name }}" placeholder="e.g., Rajesh Kumar" required>
                <div class="error-message" id="driverNameError">Please enter driver name</div>
              </div>

              <!-- Mobile Number Field -->
              <div class="form-group">
                <label for="mobile_no">Driver Mobile Number</label>
                <input type="tel" id="mobile_no" name="mobile_no" value="{{ roaster.mobile_no }}" placeholder="e.g., 9876543210" pattern="[0-9]{10}" required>
                <div class="error-message" id="mobileError">Please enter valid 10-digit mobile number</div>
              </div>

              {% comment %} <div class="form-group">
                <label for="transport-type">Transportation Type</label>
                <select id="transport-type" name="transportationTypeId" required>
                  <option value="">Select</option>
                  {% for type in transportation_types %}
                      <option value="{{ type.id }}" {% if roaster.transportationTypeId_id == type.id %}selected{% endif %}>{{ type.Name }}</option>
                  {% endfor %}
                </select>
                <div class="error-message" id="transportTypeError">Please select transportation type</div>
              </div> {% endcomment %}

              <!-- Pickup Location -->
              <div class="form-group">
                  <label for="pickup_location">Pickup Location</label>
                  <select id="pickup_location" name="pickup_location" required>
                      <option value="">Select Pickup Location</option>
                      {% for key, value in location_choices %}
                          <option value="{{ key }}" 
                              {% if roaster.pickup_location == key %}selected{% endif %}>
                              {{ value }}
                          </option>
                      {% endfor %}
                  </select>
                  <div class="error-message" id="pickupLocationError">Please select pickup location</div>
              </div>

              <div class="custom-location-group" id="pickup_custom_group" style="display: {% if roaster.pickup_location == 'OTHER' %}block{% else %}none{% endif %};">
                  <label for="pickup_location_custom">Specify Pickup Location</label>
                  <input type="text" id="pickup_location_custom" name="pickup_location_custom" 
                         value="{{ roaster.pickup_location_custom|default:'' }}"
                         placeholder="Enter specific pickup location (e.g., Hotel Taj, Conference Center, etc.)">
                  <div class="error-message" id="pickupCustomError">Please specify pickup location for "Other"</div>
              </div>

              <!-- Drop Location -->
              <div class="form-group">
                  <label for="drop_location">Drop Location</label>
                  <select id="drop_location" name="drop_location" required>
                      <option value="">Select Drop Location</option>
                      {% for key, value in location_choices %}
                          <option value="{{ key }}" class="drop-option" 
                              {% if roaster.drop_location == key %}selected{% endif %}>
                              {{ value }}
                          </option>
                      {% endfor %}
                  </select>
                  <div class="error-message" id="dropLocationError">Please select drop location</div>
              </div>

              <div class="custom-location-group" id="drop_custom_group" style="display: {% if roaster.drop_location == 'OTHER' %}block{% else %}none{% endif %};">
                  <label for="drop_location_custom">Specify Drop Location</label>
                  <input type="text" id="drop_location_custom" name="drop_location_custom" 
                         value="{{ roaster.drop_location_custom|default:'' }}"
                         placeholder="Enter specific drop location (e.g., Hotel Taj, Conference Center, etc.)">
                  <div class="error-message" id="dropCustomError">Please specify drop location for "Other"</div>
              </div>

              <!-- Assigned Players -->
              <div class="form-group">
                <label>Assigned Players</label>
                <div class="players-dropdown" id="playersDropdownWrapper">
                  <button type="button" class="players-select-button" id="playersSelectButton">
                    <span id="selectedPlayersText">Select</span> ▼
                  </button>
                  <div class="players-dropdown-menu" id="playersDropdownMenu">
                    <input type="text" id="playerSearch" placeholder="Search players..." style="width: 100%; margin-bottom: 5px; padding: 5px;">
                    {% for player in players %}
                      <div class="player-option" data-name="{{ player.name|lower }}">
                        <input type="checkbox" id="player-{{ player.id }}" name="players" value="{{ player.id }}" 
                               {% for assigned_id in assigned_player_ids %}{% if assigned_id == player.id %}checked{% endif %}{% endfor %}>
                        <label for="player-{{ player.id }}">{{ player.name }}</label>
                      </div>
                    {% endfor %}
                  </div>
                </div>
                <div class="player-counter" id="playerCounter">0/0 players assigned</div>
                <div class="error-message" id="playersError">Please select at least one player</div>
              </div>

              <!-- Date & Time -->
              <div class="form-group">
                <label for="date">Date & Time</label>
                {% with roaster.travel_date|default:roaster.created_on as travel_date %}
                <input type="datetime-local" id="date" name="travel_date" value="{{ travel_date|date:'Y-m-d\\TH:i' }}" required>
                {% endwith %}
                <div class="error-message" id="dateError">Please select date and time</div>
              </div>
            </div>

            <div class="form-actions">
              <button type="submit" class="btn--submit">Save Roaster</button>
              <button type="button" class="btn--cancel" onclick="goBack()">Cancel</button>
            </div>
          </form>
        </div>
      </div>
    </main>
  </div>

  <script>
    // Flatpickr initialization
    flatpickr("#date", {
      enableTime: true,
      dateFormat: "Y-m-d h:i K",
      time_24hr: false 
    });

    // Global variables
    const currentPage = "{{ current_page }}";
    const numberOfSeatsSelect = document.getElementById('numberOfSeats');
    const playerCounter = document.getElementById('playerCounter');
    const playerSearch = document.getElementById('playerSearch');
    const playersDropdownMenu = document.getElementById('playersDropdownMenu');
    const playersSelectButton = document.getElementById('playersSelectButton');
    const playerOptions = Array.from(playersDropdownMenu.querySelectorAll('.player-option'));
    const playersDropdownWrapper = document.getElementById('playersDropdownWrapper');
    const roasterForm = document.getElementById('roasterForm');
    let selectedPlayers = [];

    // Navigation
    function goBack() {
      const url = new URL("{% url 'roaster_list' %}", window.location.origin);
      url.searchParams.set('page', currentPage);
      window.location.href = url.toString();
    }

    // Location handling
    function toggleCustomLocation(type) {
      const selectElement = document.getElementById(`${type}_location`);
      const customGroup = document.getElementById(`${type}_custom_group`);
      const customInput = document.getElementById(`${type}_location_custom`);
      
      if (selectElement.value === 'OTHER') {
        customGroup.style.display = 'block';
        customInput.required = true;
      } else {
        customGroup.style.display = 'none';
        customInput.required = false;
        customInput.value = '';
        hideError(`${type}CustomError`);
      }
    }

    // Location dependency logic
    function updateDropLocationOptions() {
      const pickupLocation = document.getElementById('pickup_location').value;
      const dropLocationSelect = document.getElementById('drop_location');
      const dropOptions = dropLocationSelect.querySelectorAll('.drop-option');
      
      // Reset all options
      dropOptions.forEach(option => {
        option.style.display = 'block';
        option.disabled = false;
        option.classList.remove('disabled-option');
      });
      
      // If airport is selected in pickup, only show hotel in drop
      if (pickupLocation === 'AIRPORT_MOPA' || pickupLocation === 'AIRPORT_DABOLIM') {
        dropOptions.forEach(option => {
          if (option.value !== 'HOTEL') {
            option.style.display = 'none';
            option.disabled = true;
            option.classList.add('disabled-option');
          }
        });
        
        // If current drop selection is invalid, reset it
        if (dropLocationSelect.value !== 'HOTEL' && dropLocationSelect.value !== '') {
          dropLocationSelect.value = '';
          showError('dropLocationError', 'Drop location must be Hotel when pickup is Airport');
        } else {
          hideError('dropLocationError');
        }
      }
      
      // If hotel is selected in pickup, don't allow hotel in drop
      if (pickupLocation === 'HOTEL') {
        dropOptions.forEach(option => {
          if (option.value === 'HOTEL') {
            option.style.display = 'none';
            option.disabled = true;
            option.classList.add('disabled-option');
          }
        });
        
        // If current drop selection is hotel, reset it
        if (dropLocationSelect.value === 'HOTEL') {
          dropLocationSelect.value = '';
          showError('dropLocationError', 'Drop location cannot be Hotel when pickup is Hotel');
        } else {
          hideError('dropLocationError');
        }
      }
      
      // Trigger custom location toggles
      toggleCustomLocation('drop');
    }

    // Mobile number validation
    function validateMobileNumber() {
      const mobileInput = document.getElementById('mobile_no');
      const mobileValue = mobileInput.value.trim();
      const mobileRegex = /^[0-9]{10}$/;
      
      if (!mobileRegex.test(mobileValue)) {
        showError('mobileError', 'Please enter a valid 10-digit mobile number');
        return false;
      } else {
        hideError('mobileError');
        return true;
      }
    }

    // Error handling functions
    function showError(errorId, message) {
      const errorElement = document.getElementById(errorId);
      errorElement.textContent = message;
      errorElement.style.display = 'block';
      
      const inputId = errorId.replace('Error', '');
      const inputElement = document.getElementById(inputId);
      if (inputElement) {
        inputElement.classList.add('location-error');
      }
    }

    function hideError(errorId) {
      const errorElement = document.getElementById(errorId);
      errorElement.style.display = 'none';
      
      const inputId = errorId.replace('Error', '');
      const inputElement = document.getElementById(inputId);
      if (inputElement) {
        inputElement.classList.remove('location-error');
      }
    }

    function clearAllErrors() {
      const errorElements = document.querySelectorAll('.error-message');
      errorElements.forEach(error => {
        error.style.display = 'none';
      });
      
      const errorInputs = document.querySelectorAll('.location-error');
      errorInputs.forEach(input => {
        input.classList.remove('location-error');
      });
    }

    // Enhanced location validation - PREVENT OTHER → OTHER
    function validateLocationCombination() {
      const pickupLocation = document.getElementById('pickup_location').value;
      const dropLocation = document.getElementById('drop_location').value;
      
      if (pickupLocation === 'OTHER' && dropLocation === 'OTHER') {
        showError('pickupLocationError', 'Cannot create transport from "Other" to "Other" location');
        showError('dropLocationError', 'Cannot create transport from "Other" to "Other" location');
        
        document.getElementById('pickup_location').classList.add('location-error');
        document.getElementById('drop_location').classList.add('location-error');
        
        return false;
      } else {
        hideError('pickupLocationError');
        hideError('dropLocationError');
        
        document.getElementById('pickup_location').classList.remove('location-error');
        document.getElementById('drop_location').classList.remove('location-error');
        
        return true;
      }
    }

    // Validate custom location fields
    function validateCustomLocations() {
      const pickupLocation = document.getElementById('pickup_location').value;
      const dropLocation = document.getElementById('drop_location').value;
      const pickupCustom = document.getElementById('pickup_location_custom').value;
      const dropCustom = document.getElementById('drop_location_custom').value;

      if (pickupLocation === 'OTHER' && !pickupCustom.trim()) {
        showError('pickupCustomError', 'Please specify the pickup location for "Other"');
        return false;
      } else {
        hideError('pickupCustomError');
      }

      if (dropLocation === 'OTHER' && !dropCustom.trim()) {
        showError('dropCustomError', 'Please specify the drop location for "Other"');
        return false;
      } else {
        hideError('dropCustomError');
      }

      return true;
    }

    // Player selection functionality
    function getSeatInfo() {
      const totalSeats = parseInt(numberOfSeatsSelect.value) || 0;
      const assigned = selectedPlayers.length;
      const isValid = totalSeats === 0 || assigned <= totalSeats;
      const availableSeats = totalSeats - assigned;
      
      return { totalSeats, assigned, isValid, availableSeats };
    }

    function updatePlayerCounter() {
      const checkboxes = playersDropdownMenu.querySelectorAll('input[type="checkbox"]');
      
      selectedPlayers = Array.from(checkboxes)
        .filter(checkbox => checkbox.checked)
        .map(checkbox => checkbox.value);
      
      const { totalSeats, assigned, isValid, availableSeats } = getSeatInfo();
      
      if (totalSeats === 0) {
        playerCounter.textContent = `${assigned} players assigned (no seat limit)`;
        playerCounter.style.color = assigned === 0 ? '#555' : 'green';
      } else {
        playerCounter.textContent = `${assigned}/${totalSeats} players assigned`;
        playerCounter.style.color = isValid ? (assigned === 0 ? '#555' : 'green') : 'red';
        
        if (!isValid) {
          playerCounter.textContent += ' - Too many players!';
        } else if (availableSeats === 0) {
          playerCounter.textContent += ' - Vehicle full!';
        }
      }
      
      const selectedPlayersText = document.getElementById('selectedPlayersText');
      if (assigned === 0) {
        selectedPlayersText.textContent = 'Select';
      } else {
        selectedPlayersText.textContent = `${assigned} player${assigned > 1 ? 's' : ''} selected`;
      }
      
      if (totalSeats > 0 && assigned >= totalSeats) {
        checkboxes.forEach(checkbox => {
          if (!checkbox.checked) {
            checkbox.disabled = true;
            checkbox.parentElement.style.opacity = '0.5';
          }
        });
      } else {
        checkboxes.forEach(checkbox => {
          checkbox.disabled = false;
          checkbox.parentElement.style.opacity = '1';
        });
      }
      
      if (assigned === 0) {
        showError('playersError', 'Please select at least one player');
      } else {
        hideError('playersError');
      }
      
      return isValid;
    }

    // Dropdown functionality
    playersSelectButton.addEventListener('click', () => {
      playersDropdownWrapper.classList.toggle('show');
    });

    document.addEventListener('click', function(e) {
      if (!playersDropdownWrapper.contains(e.target)) {
        playersDropdownWrapper.classList.remove('show');
      }
    });

    // Player search
    playerSearch.addEventListener('input', function() {
      const query = this.value.toLowerCase();
      playerOptions.forEach(option => {
        if (option.dataset.name.includes(query)) {
          option.style.display = 'block';
        } else {
          option.style.display = 'none';
        }
      });
    });

    // Comprehensive form validation
    function validateForm() {
      let isValid = true;
      clearAllErrors();

      const requiredFields = [
        { id: 'vehicleType', errorId: 'vehicleTypeError', message: 'Please select a vehicle type' },
        { id: 'vehicleNumber', errorId: 'vehicleNumberError', message: 'Please enter vehicle number' },
        { id: 'numberOfSeats', errorId: 'seatsError', message: 'Please enter valid number of seats' },
        { id: 'driverName', errorId: 'driverNameError', message: 'Please enter driver name' },
        { id: 'mobile_no', errorId: 'mobileError', message: 'Please enter mobile number' },
        { id: 'transport-type', errorId: 'transportTypeError', message: 'Please select transportation type' },
        { id: 'pickup_location', errorId: 'pickupLocationError', message: 'Please select pickup location' },
        { id: 'drop_location', errorId: 'dropLocationError', message: 'Please select drop location' },
        { id: 'date', errorId: 'dateError', message: 'Please select date and time' }
      ];

      requiredFields.forEach(field => {
        const element = document.getElementById(field.id);
        if (!element.value.trim()) {
          showError(field.errorId, field.message);
          isValid = false;
        }
      });

      const seats = parseInt(numberOfSeatsSelect.value);
      if (isNaN(seats) || seats < 1) {
        showError('seatsError', 'Please enter a valid number of seats (minimum 1)');
        isValid = false;
      }

      if (!validateLocationCombination()) {
        isValid = false;
      }

      if (!validateCustomLocations()) {
        isValid = false;
      }

      // Validate mobile number
      if (!validateMobileNumber()) {
        isValid = false;
      }

      const { totalSeats, assigned } = getSeatInfo();
      
      if (assigned === 0) {
        showError('playersError', 'Please select at least one player');
        isValid = false;
      } else if (totalSeats > 0 && assigned > totalSeats) {
        showError('playersError', `Too many players selected: ${assigned} players but only ${totalSeats} seats available`);
        isValid = false;
      }

      return isValid;
    }

    // Real-time validation for number of seats
    numberOfSeatsSelect.addEventListener('input', function() {
      const seats = parseInt(this.value);
      if (isNaN(seats) || seats < 1) {
        showError('seatsError', 'Please enter a valid number of seats (minimum 1)');
      } else {
        hideError('seatsError');
        updatePlayerCounter();
      }
    });

    // Real-time validation for custom locations
    document.getElementById('pickup_location_custom').addEventListener('input', function() {
      if (this.value.trim()) {
        hideError('pickupCustomError');
      } else {
        const pickupLocation = document.getElementById('pickup_location').value;
        if (pickupLocation === 'OTHER') {
          showError('pickupCustomError', 'Please specify the pickup location for "Other"');
        }
      }
    });

    document.getElementById('drop_location_custom').addEventListener('input', function() {
      if (this.value.trim()) {
        hideError('dropCustomError');
      } else {
        const dropLocation = document.getElementById('drop_location').value;
        if (dropLocation === 'OTHER') {
          showError('dropCustomError', 'Please specify the drop location for "Other"');
        }
      }
    });

    // Mobile number validation on input
    document.getElementById('mobile_no').addEventListener('input', function() {
      validateMobileNumber();
    });

    // Event listeners for location changes
    document.getElementById('pickup_location').addEventListener('change', function() {
      toggleCustomLocation('pickup');
      updateDropLocationOptions();
      validateLocationCombination();
      validateCustomLocations();
    });

    document.getElementById('drop_location').addEventListener('change', function() {
      toggleCustomLocation('drop');
      validateLocationCombination();
      validateCustomLocations();
    });

    // Form submission - PREVENT SUBMISSION WHEN BOTH ARE OTHER
    roasterForm.addEventListener('submit', function(e) {
      const pickupLocation = document.getElementById('pickup_location').value;
      const dropLocation = document.getElementById('drop_location').value;
      
      // Immediate check for Other → Other combination
      if (pickupLocation === 'OTHER' && dropLocation === 'OTHER') {
        e.preventDefault();
        showError('pickupLocationError', 'Cannot create transport from "Other" to "Other" location');
        showError('dropLocationError', 'Cannot create transport from "Other" to "Other" location');
        
        document.getElementById('pickup_location').scrollIntoView({ 
          behavior: 'smooth', 
          block: 'center' 
        });
        
        alert('Error: Cannot create transport from "Other" to "Other" location. Please change either pickup or drop location.');
        return false;
      }
      
      // Continue with full form validation
      if (!validateForm()) {
        e.preventDefault();
        const firstError = document.querySelector('.error-message[style="display: block;"]');
        if (firstError) {
          firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        return false;
      }
    });

    // Event listeners for dynamic updates
    playersDropdownMenu.addEventListener('change', updatePlayerCounter);
    numberOfSeatsSelect.addEventListener('change', updatePlayerCounter);

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
      toggleCustomLocation('pickup');
      toggleCustomLocation('drop');
      updateDropLocationOptions();
      updatePlayerCounter();
      validateLocationCombination();
    });
  </script>
</body>
</html>