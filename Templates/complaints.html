{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manage Complaints - FIDE World Cup 2025</title>
  <link rel="stylesheet" href="{% static 'assets/css/app.css' %}">
</head>
<body>
  <div class="app-shell">
    {% include 'sidebar.html' %}
    <main class="main-content">
      <div class="page-header">
        <h1>Manage Complaints</h1>
      </div>
      <div class="toolbar">
        <div class="search-box">
          <input type="text" id="complaint-search" placeholder="Search Complaints" value="{{ search_query }}">
        </div>
      </div>
      <div class="complaints-list">
        {% for c in complaints %}
        <article class="complaint-card" data-id="{{ c.id }}" data-status="{{ c.status }}">
          <div class="complaint-header">
            <h3>#C{{ c.id }}</h3>
            <div class="complaint-meta">
              <span class="player-name">{{ c.player.name }}</span>
              <span class="complaint-date">{{ c.created_on|date:"M d, Y" }}</span>
            </div>
            <select class="status-select" data-complaint-id="{{ c.id }}">
              {% for value, label in c.STATUS_CHOICES %}
                <option value="{{ value }}" {% if c.status == value %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
          </div>
        
          <div class="complaint-body">
            <p class="complaint-description">{{ c.description }}</p>
            <div class="remarks-section">
              <textarea class="remarks-input" placeholder="Write remarks..." data-complaint-id="{{ c.id }}"></textarea>
              <button class="btn btn--small btn--primary" data-action="send-remark" data-complaint-id="{{ c.id }}">Send</button>
            </div>

            {% if c.conversations.all %}
                {% for convo in c.conversations.all %}
                  <div class="admin-reply" data-complaint-id="{{ c.id }}">
                    <div class="remark-item">
                      <strong>
                        {% if convo.sender_player %}
                          {{ convo.sender_player.name }}
                        {% elif convo.sender_user %}
                          {{ convo.sender_user.name }}
                        {% else %}
                          Unknown
                        {% endif %}
                      </strong>
                      ({{ convo.created_on|date:"M d, Y H:i" }}):
                      <p>{{ convo.message }}</p>
                    </div>
                  </div>
                {% endfor %}
            {% else %}
                <p class="no-remarks">No remarks yet.</p>
            {% endif %}      
          </div>
        </article>
  {% empty %}
    <div class="no-complaints-card">
      <div class="no-complaints-icon">ðŸ“­</div>
      <h3>No Complaints Found</h3>
      <p>There are currently no complaints submitted by any players.</p>
    </div>
  {% endfor %}
  </div>
  <div class="pagination">
    {% if page_obj.has_previous %}
      <a href="?page={{ page_obj.previous_page_number }}&q={{ search_query }}">Previous</a>
    {% endif %}
  
    <span>Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
  
    {% if page_obj.has_next %}
      <a href="?page={{ page_obj.next_page_number }}&q={{ search_query }}">Next</a>
    {% endif %}
  </div>


    </main>
  </div>

  <script>
  document.addEventListener("DOMContentLoaded", () => {

    // Enter key press in search input
    document.getElementById("complaint-search").addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        const query = e.target.value.trim();
        window.location.href = `?q=${encodeURIComponent(query)}`;
      }
    });

    // Send remark
    document.querySelectorAll("[data-action='send-remark']").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.dataset.complaintId;
        const textarea = document.querySelector(`.remarks-input[data-complaint-id='${id}']`);
        const message = textarea.value.trim();
        // Also get the current status value
        const statusSelect = document.querySelector(`.status-select[data-complaint-id='${id}']`);
        const status = statusSelect ? statusSelect.value : "";
        if (!message && !status) {
          return alert("Please enter a remark or select a status.");
        }

        fetch(`/complaints/${id}/update/`, {
          method: "POST",
          headers: { "X-CSRFToken": "{{ csrf_token }}" },
          body: new URLSearchParams({ status, message })
        })
        .then(res => res.json())
        .then(data => {
          alert(data.message);
          window.location.reload();
        });
      });
    });
  });
  </script>
</body>
</html>
