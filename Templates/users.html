{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manage Users - FIDE World Cup 2025</title>
  <link rel="stylesheet" href="{% static 'assets/css/app.css' %}">
</head>
<body>
<div class="app-shell">
  {% include 'sidebar.html' %}
  <main class="main-content">
    <div class="page-header"><h1>Manage Users</h1></div>
    <div class="toolbar">
      <div class="search-box">
        <input type="text" id="user-search" placeholder="Search Users">
      </div>
      <button class="btn btn--primary" data-modal-open="add-user-modal">+ Add User</button>
    </div>

    <div class="table-container">
      <table id="users-table">
        <thead>
          <tr>
            <th>Users</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Department</th>
            <th>Admin Role</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for user in page_obj %}
          <tr data-id="{{ user.id }}">
            <td>{{ user.name }}</td>
            <td>{{ user.email }}</td>
            <td>{{ user.mobilenumber }}</td>
            <td>{{ user.department.name }}</td>
            <td><span class="badge badge--{{ user.roleid.role_name|lower }}">{{ user.roleid.role_name }}</span></td>
            <td class="actions">
              <button class="btn-icon" data-action="edit">‚úèÔ∏è</button>
              <button class="btn-icon" data-action="change-password">üîë</button>
              <button class="btn-icon" data-action="delete">üóëÔ∏è</button>
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="6">No users found.</td></tr>
          {% endfor %}
        </tbody>
      </table>
      <!-- Pagination -->
        <div class="pagination">
          {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}">&laquo; Prev</a>
          {% endif %}
          <span>Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
          {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}">Next &raquo;</a>
          {% endif %}
        </div>
    </div>
  </main>
</div>

<div id="change-password-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Change Password</h2>
      <button class="modal-close" data-modal-close>&times;</button>
    </div>
    <form id="change-password-form" class="modal-body" method="post">
      {% csrf_token %}
      <div class="form-group">
        <label>New Password</label>
        <input type="password" name="new_password" required>
      </div>
      <div class="form-group">
        <label>Confirm Password</label>
        <input type="password" name="confirm_password" required>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn--secondary" data-modal-close>Cancel</button>
        <button type="submit" class="btn btn--primary">Update Password</button>
      </div>
    </form>
  </div>
</div>

<!-- Add User Modal -->
<div id="add-user-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Add New User</h2>
      <button class="modal-close" data-modal-close>&times;</button>
    </div>
    <form id="add-user-form" class="modal-body" method="post">
      {% csrf_token %}
      <div class="form-group"><label>Name</label><input type="text" name="name" required></div>
      <div class="form-group"><label>Email</label><input type="email" name="email" required></div>
      <div class="form-group"><label>Username</label><input type="test" name="username" required></div>
      <div class="form-group"><label>Phone</label><input type="text" name="phone" required></div>
      <div class="form-group"><label>Password</label><input type="password" name="password" required></div>
      <div class="form-group"><label>Confirm Password</label><input type="password" name="confirmPassword" required></div>
      <div class="form-group">
        <label for="user-role">Role</label>
        <select id="user-role" name="role" required>
          <option value="">Select Role</option>
          {% for role in roles %}
            <option value="{{ role.id }}">{{ role.role_name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group">
        <label for="user-department">Department</label>
        <select id="user-department" name="department" required>
          <option value="">Select Department</option>
          {% for dept in departments %}
            <option value="{{ dept.id }}">{{ dept.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn--secondary" data-modal-close>Cancel</button>
        <button type="submit" class="btn btn--primary">Add User</button>
      </div>
    </form>
  </div>
</div>

<div id="edit-user-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Edit User</h2>
      <button class="modal-close" data-modal-close>&times;</button>
    </div>
    <form id="edit-user-form" class="modal-body" method="post">
      {% csrf_token %}
      <div class="form-group"><label>Name</label><input type="text" name="edit_name" required></div>
      <div class="form-group"><label>Email</label><input type="email" name="edit_email" required></div>
      <div class="form-group"><label>Username</label><input type="test" name="edit_username" required></div>
      <div class="form-group"><label>Phone</label><input type="text" name="edit_phone" required></div>
      <div class="form-group">
        <label for="user-role">Role</label>
        <select id="user-role" name="edit_role" required>
          <option value="">Select Role</option>
          {% for role in roles %}
            <option value="{{ role.id }}">{{ role.role_name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group">
        <label for="user-department">Department</label>
        <select id="user-department" name="edit_department" required>
          <option value="">Select Department</option>
          {% for dept in departments %}
            <option value="{{ dept.id }}">{{ dept.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn--secondary" data-modal-close>Cancel</button>
        <button type="submit" class="btn btn--primary">Edit User</button>
      </div>
    </form>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {

    $(document).on("click", "[data-modal-open]", function() {
        const modalId = $(this).data("modal-open");
        $("#" + modalId).addClass("active");
    });

    $(document).on("click", "[data-modal-close], .modal", function(e) {
        if ($(e.target).is(".modal") || $(e.target).is("[data-modal-close]")) {
            $(this).closest(".modal").removeClass("active");
        }
    });

    // User search
    const searchInput = document.getElementById('user-search');
      searchInput.addEventListener('input', () => {
      const filter = searchInput.value.toLowerCase();
      document.querySelectorAll('#users-table tbody tr').forEach(row => {
        row.style.display = row.cells[0].innerText.toLowerCase().includes(filter) ? '' : 'none';
      });
    });
  
    // Open Change Password Modal
    $(document).on('click', '[data-action="change-password"]', function() {
        const userId = $(this).closest('tr').data('id');
        $('#change-password-modal').attr('data-id', userId).addClass('active');
    });

    // Handle password change submission
    $(document).on('submit', '#change-password-form', function(e) {
        e.preventDefault();
  
        const userId = $('#change-password-modal').attr('data-id');
        const newPass = $(this).find('input[name="new_password"]').val();
        const confirmPass = $(this).find('input[name="confirm_password"]').val();
  
        if (newPass !== confirmPass) {
            alert("Passwords do not match!");
            return;
        }

        data = {
          userId: userId,
          new_password: newPass,
          confirm_password: confirmPass,
          csrfmiddlewaretoken: '{{ csrf_token }}'
        }
  
        $.ajax({
            url: "{% url 'change_user_password' %}",
            type: 'POST',
            data: data,
            success: function(res) {
                if (res.success) {
                    alert(res.message);
                    $('#change-password-modal').removeClass('active');
                    $('#change-password-form')[0].reset();
                } else {
                    alert(res.message);
                }
            },
            error: function() {
                alert("Something went wrong. Please try again.");
            }
        });
    });


    $('#add-user-form').on('submit', function(e) {
      e.preventDefault();
      const password = $(this).find('input[name="password"]').val();
      const confirmPassword = $(this).find('input[name="confirmPassword"]').val();
      if (password !== confirmPassword) {
          alert('Passwords do not match! Please check.');
          $(this).find('input[name="confirmPassword"]').focus();
          return false;
      }
      $.ajax({
          url: "{% url 'manage_users' %}",
          type: 'POST',
          data: $(this).serialize(),
          success: function(res) {
              if (res.success) {
                  alert(res.message);
                  $('#add-user-modal').removeClass('active');
                  $('#add-user-form')[0].reset();            
                  location.reload();                         
              } else {
                  alert(res.message);
              }
          },
          error: function() {
              alert("Something went wrong. Please try again.");
          }
      });
    });


    $(document).on('submit', '#edit-user-form', function(e) {
        e.preventDefault();
        const userId = $('#edit-user-modal').attr('data-id');
        $.ajax({
            url: `/users/edit/${userId}/`,
            type: 'POST',
            data: $(this).serialize(),
            success: function(res) {
                if (res.success) {
                    alert(res.message);
                    location.reload();
                }
            }
        });
    });

    $(document).on('click', '[data-action="delete"]', function() {
        const row = $(this).closest('tr');
        const userId = row.data('id');
        if (!confirm('Are you sure you want to delete this user?')) return;

        $.ajax({
          url: `/users/delete/${userId}/`,
          type: 'POST',
          data: { csrfmiddlewaretoken: '{{ csrf_token }}' },
          success: function(res) {
            if (res.success) {
              alert(res.message);
              row.remove();
            }
          }
        });
    });

    // Edit user
    $(document).on('click', '[data-action="edit"]', function() {
        const userId = $(this).closest('tr').data('id');
    
        $.ajax({
            url: `/users/edit/${userId}/`,
            type: 'GET',
            success: function(res) {
                if (res.success) {
                    const u = res.data;
                    const modal = $('#edit-user-modal');
                    modal.find('input[name="edit_name"]').val(u.name);
                    modal.find('input[name="edit_email"]').val(u.email);
                    modal.find('input[name="edit_username"]').val(u.username);
                    modal.find('input[name="edit_phone"]').val(u.mobilenumber);
                    modal.find('select[name="edit_department"]').val(u.department);
                    modal.find('select[name="edit_role"]').val(u.roleid);
                    modal.attr('data-id', userId).addClass('active');
                }
            }
        });
    });

});
</script>
</body>
</html>
